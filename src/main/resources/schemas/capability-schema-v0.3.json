{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://naftiko.io/schemas/v0.3/capability.json",
  "name": "Naftiko Capability Specification",
  "description": "This Schema should be used to describe and validate Naftiko Capabilities",
  "type": "object",
  "properties": {
    "naftiko": {
      "type": "string",
      "description": "Version of the Naftiko schema",
      "const": "0.3"
    },
    "info": {
      "$ref": "#/$defs/Info"
    },
    "capability": {
      "$ref": "#/$defs/Capability"
    }
  },
  "required": [
    "naftiko",
    "info",
    "capability"
  ],
  "additionalProperties": false,
  "$defs": {
    "InputParameter": {
      "type": "object",
      "description": "Describes a single function parameter. A unique parameter is defined by a combination of a name and location.",
      "properties": {
        "name": {
          "type": "string",
          "description": "Name of the parameter",
          "pattern": "^[a-zA-Z0-9-_]+$"
        },
        "in": {
          "type": "string",
          "description": "Location of the parameter",
          "enum": [
            "query",
            "header",
            "path",
            "cookie",
            "body"
          ]
        },
        "value": {
          "type": "string",
          "description": "Value or JSONPath reference"
        }
      },
      "required": [
        "name",
        "in"
      ],
      "additionalProperties": false
    },
    "OutputParameter": {
      "type": "object",
      "description": "Describes a single function output parameter. It is referenced by and ID for later usage in the Exposes layer to define how the output of a consumed function is mapped.",
      "properties": {
        "name": {
          "type": "string",
          "description": "The name of the output parameter",
          "pattern": "^[a-zA-Z0-9-_]+$"
        },
        "value": {
          "type": "string",
          "description": "The value of the output parameter. It is retrived by reference to the consumed function response using JsonPath syntax. E.g. $response.data.user.id"
        }
      },
      "required": [
        "name"
      ],
      "additionalProperties": false
    },
    "Hostname": {
      "type": "string",
      "description": "Valid hostname",
      "pattern": "^([a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)(\\.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$"
    },
    "IPv4": {
      "type": "string",
      "description": "Valid IPv4 address",
      "pattern": "^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$"
    },
    "IPv6": {
      "type": "string",
      "description": "Valid IPv6 address (simplified)",
      "pattern": "^([0-9a-fA-F]{0,4}:){2,7}[0-9a-fA-F]{0,4}$"
    },
    "Address": {
      "description": "hostname or IP for the exposition",
      "anyOf": [
        {
          "$ref": "#/$defs/Hostname"
        },
        {
          "$ref": "#/$defs/IPv4"
        },
        {
          "$ref": "#/$defs/IPv6"
        }
      ]
    },
    "Info": {
      "type": "object",
      "description": "Information about the capability",
      "properties": {
        "label": {
          "type": "string",
          "description": "The display name of the capability"
        },
        "description": {
          "type": "string",
          "description": "A description of the capability (the more meaningful, the easier for agents discovery)"
        },
        "tags": {
          "type": "array",
          "description": "List of tags to help categorize the capability. It can be used for discovery and filtering purposes.",
          "items": {
            "type": "string"
          }
        },
        "created": {
          "type": "string",
          "pattern": "^\\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12]\\d|3[01])$",
          "description": "The date and time when the capability was created"
        },
        "modified": {
          "type": "string",
          "pattern": "^\\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12]\\d|3[01])$",
          "description": "The date and time when the capability was last modified"
        },
        "stakeholders": {
          "type": "array",
          "description": "List of stakeholders related to this capability. It can be used for discovery and filtering purposes.",
          "items": {
            "$ref": "#/$defs/Person"
          }
        }
      },
      "required": [
        "label",
        "description"
      ],
      "additionalProperties": false
    },
    "Person": {
      "type": "object",
      "description": "A person related to the capability",
      "properties": {
        "role": {
          "type": "string",
          "description": "The role of the person in relation to the capability. E.g. owner, editor, viewer"
        },
        "fullName": {
          "type": "string",
          "description": "The full name of the person"
        },
        "email": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9._%+\\-]+@[a-zA-Z0-9.\\-]+\\.[a-zA-Z]{2,}$",
          "description": "The email address of the person"
        }
      },
      "required": [
        "role",
        "fullName"
      ],
      "additionalProperties": false
    },
    "Capability": {
      "type": "object",
      "description": "Capability technical configuration",
      "properties": {
        "exposes": {
          "type": "array",
          "description": "List of exposed server adapters",
          "items": {
            "$ref": "#/$defs/ExposesApi"
          },
          "minItems": 1
        },
        "consumes": {
          "type": "array",
          "description": "Consumed client adapters",
          "items": {
            "$ref": "#/$defs/ConsumesHttp"
          },
          "minItems": 1
        }
      },
      "required": [
        "exposes",
        "consumes"
      ],
      "additionalProperties": false
    },
    "ExposesApi": {
      "type": "object",
      "description": "API exposition configuration",
      "properties": {
        "type": {
          "type": "string",
          "const": "api"
        },
        "address": {
          "$ref": "#/$defs/Address"
        },
        "port": {
          "type": "integer",
          "minimum": 1,
          "maximum": 65535
        },
        "namespace": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9-]+$",
          "description": "Unique identifier for this exposed API"
        },
        "authentication": {
          "$ref": "#/$defs/Authentication"
        },
        "resources": {
          "type": "array",
          "description": "List of exposed resources",
          "items": {
            "$ref": "#/$defs/ExposedResource"
          },
          "minItems": 1
        }
      },
      "required": [
        "type",
        "port",
        "namespace",
        "resources"
      ],
      "additionalProperties": false
    },
    "ExposedResource": {
      "type": "object",
      "description": "An exposed resource",
      "properties": {
        "label": {
          "type": "string",
          "description": "Display name for the resource. It will likely be used in UIs."
        },
        "description": {
          "type": "string",
          "description": "Used to provide *meaningul* infimration about the resource. Remember, in a world of agents, context is king."
        },
        "path": {
          "type": "string",
          "description": "Path of the resource (supports {{param}} placeholders)"
        },
        "name": {
          "type": "string",
          "description": "Technicnal name for the resource. It will likely be used for reference",
          "pattern": "^[a-zA-Z0-9-]+$"
        },
        "inputParameters": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/InputParameter"
          }
        },
        "operations": {
          "type": "array",
          "description": "Operations available on this resource",
          "items": {
            "$ref": "#/$defs/ExposedOperation"
          }
        },
        "forward": {
          "$ref": "#/$defs/ForwardConfig"
        }
      },
      "required": [
        "description",
        "path"
      ],
      "oneOf": [
        {
          "required": [
            "operations"
          ]
        },
        {
          "required": [
            "forward"
          ]
        }
      ],
      "additionalProperties": false
    },
    "ExposedOperation": {
      "type": "object",
      "description": "An operation exposed on a resource",
      "properties": {
        "name": {
          "type": "string",
          "description": "Technicnal name for the resource. It will likely be used for reference",
          "pattern": "^[a-zA-Z0-9-]+$"
        },
        "label": {
          "type": "string",
          "description": "Display name for the resource. It will likely be used in UIs."
        },
        "method": {
          "type": "string",
          "enum": [
            "GET",
            "POST",
            "PUT",
            "PATCH",
            "DELETE"
          ],
          "default": "GET"
        },
        "inputParameters": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/InputParameter"
          }
        },
        "outputParameters": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/OutputParameter"
          }
        },
        "steps": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/OperationStep"
          },
          "minItems": 1
        }
      },
      "required": [
        "method",
        "name",
        "steps"
      ],
      "additionalProperties": false
    },
    "ConsumesHttp": {
      "type": "object",
      "description": "HTTP API consumption configuration",
      "properties": {
        "namespace": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9-]+$",
          "description": "Unique identifier for this consumed API"
        },
        "type": {
          "type": "string",
          "const": "http"
        },
        "baseUri": {
          "type": "string",
          "description": "Target URI for the consumes API",
          "pattern": "^https?://[^/]+(/[^{]*)?$"
        },
        "inputParameters": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/InputParameter"
          }
        },
        "authentication": {
          "$ref": "#/$defs/Authentication"
        },
        "headers": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[^:]+:\\s*.+$"
          }
        },
        "resources": {
          "type": "array",
          "description": "List of consumed resources",
          "items": {
            "$ref": "#/$defs/ConsumedHttpResource"
          },
          "minItems": 1
        }
      },
      "required": [
        "namespace",
        "type",
        "baseUri",
        "resources"
      ],
      "additionalProperties": false
    },
    "ConsumedHttpResource": {
      "type": "object",
      "description": "A consumed HTTP resource",
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9-]+$"
        },
        "label": {
          "type": "string"
        },
        "description": {
          "type": "string"
        },
        "path": {
          "type": "string"
        },
        "inputParameters": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/InputParameter"
          }
        },
        "operations": {
          "type": "array",
          "description": "Operations on this resource",
          "items": {
            "$ref": "#/$defs/ConsumedHttpOperation"
          },
          "minItems": 1
        }
      },
      "required": [
        "name",
        "path",
        "operations"
      ],
      "additionalProperties": false
    },
    "ConsumedHttpOperation": {
      "type": "object",
      "description": "An operation on a consumed HTTP resource",
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9-]+$"
        },
        "label": {
          "type": "string"
        },
        "method": {
          "type": "string",
          "enum": [
            "GET",
            "POST",
            "PUT",
            "PATCH",
            "DELETE"
          ],
          "default": "GET"
        },
        "inputParameters": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/InputParameter"
          }
        },
        "outputRawFormat": {
          "type": "string",
          "enum": [
            "json",
            "XML"
          ],
          "default": "json",
          "description": "The raw format of the response from the consumed API. It is used to determine how to parse the response and extract the output parameters. Defualt value is json."
        },
        "outputParameters": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/OutputParameter"
          }
        },
        "body": {
          "$ref": "#/$defs/RequestBody"
        }
      },
      "required": [
        "name",
        "method"
      ],
      "additionalProperties": false
    },
    "OperationStep": {
      "type": "object",
      "description": "Describes a single sequence step called in a sequence of calls in order to execute a request",
      "properties": {
        "call": {
          "type": "string",
          "description": "The reference of the source where the consumed request lies. It should follow the syntax {{namespace}}.{{operationId}}. E.g. : notion.get-database or github.get-user",
          "pattern": "^[a-zA-Z0-9-]+\\.[a-zA-Z0-9-]+$"
        },
        "inputParameters": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/OperationStepParameter"
          }
        },
        "mappings": {
          "type": "array",
          "description": "Defines how to map the output parameters of this step to the input parameters of the next steps or to the output parameters of the exposed operation. It is an array of mapping objects with targetName and value properties. The targetName is the name of the parameter to map to, and the value is a JsonPath reference to the value to map from. E.g. {targetName: 'database_id', value: '$.get-database.database_id'}",
          "items": {
            "$ref": "#/$defs/StepOutputMapping"
          }
        }
      },
      "required": [
        "call"
      ],
      "additionalProperties": false
    },
    "StepOutputMapping": {
      "type": "object",
      "description": "Describes how to map the output of an operation step to the input of another step or to the output of the exposed operation",
      "properties": {
        "targetName": {
          "type": "string",
          "description": "The name of the parameter to map to. It can be an input parameter of a next step or an output parameter of the exposed operation"
        },
        "value": {
          "type": "string",
          "description": "A JsonPath reference to the value to map from. E.g. $.get-database.database_id"
        }
      },
      "required": [
        "targetName",
        "value"
      ],
      "additionalProperties": false
    },
    "OperationStepParameter": {
      "type": "object",
      "description": "Describes a single parameter in an operation step",
      "properties": {
        "name": {
          "type": "string",
          "description": "The name of the parameter in the called operation"
        },
        "value": {
          "type": "string",
          "description": "The value of the parameter. It can be a static value or a reference to a previous step output using JsonPath syntax. E.g. $this.step1.output.data.id"
        }
      },
      "required": [
        "name",
        "value"
      ],
      "additionalProperties": false
    },
    "RequestBodyJson": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "json"
        },
        "data": {
          "oneOf": [
            {
              "type": "string"
            },
            {
              "type": "object"
            },
            {
              "type": "array"
            }
          ]
        }
      },
      "required": [
        "type",
        "data"
      ],
      "additionalProperties": false
    },
    "RequestBodyText": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "text",
            "xml",
            "sparql"
          ]
        },
        "data": {
          "type": "string"
        }
      },
      "required": [
        "type",
        "data"
      ],
      "additionalProperties": false
    },
    "RequestBodyFormUrlEncoded": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "formUrlEncoded"
        },
        "data": {
          "oneOf": [
            {
              "type": "string"
            },
            {
              "type": "object",
              "additionalProperties": {
                "type": "string"
              }
            }
          ]
        }
      },
      "required": [
        "type",
        "data"
      ],
      "additionalProperties": false
    },
    "RequestBodyMultipartFormPart": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string"
        },
        "value": {
          "type": "string"
        },
        "filename": {
          "type": "string"
        },
        "contentType": {
          "type": "string"
        }
      },
      "required": [
        "name",
        "value"
      ],
      "additionalProperties": false
    },
    "RequestBodyMultipartForm": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "multipartForm"
        },
        "data": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/RequestBodyMultipartFormPart"
          }
        }
      },
      "required": [
        "type",
        "data"
      ],
      "additionalProperties": false
    },
    "RequestBody": {
      "description": "Request body configuration",
      "oneOf": [
        {
          "$ref": "#/$defs/RequestBodyJson"
        },
        {
          "$ref": "#/$defs/RequestBodyText"
        },
        {
          "$ref": "#/$defs/RequestBodyFormUrlEncoded"
        },
        {
          "$ref": "#/$defs/RequestBodyMultipartForm"
        }
      ]
    },
    "ForwardConfig": {
      "type": "object",
      "description": "Configuration for forwarding requests to a consumed namespace",
      "properties": {
        "targetNamespace": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9-]+$",
          "description": "The namespace to forward requests to"
        },
        "trustedHeaders": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "List of headers that can be forwarded",
          "minItems": 1
        }
      },
      "required": [
        "targetNamespace",
        "trustedHeaders"
      ],
      "additionalProperties": false
    },
    "Authentication": {
      "description": "Authentication",
      "oneOf": [
        {
          "$ref": "#/$defs/AuthBasic"
        },
        {
          "$ref": "#/$defs/AuthApiKey"
        },
        {
          "$ref": "#/$defs/AuthBearer"
        },
        {
          "$ref": "#/$defs/AuthDigest"
        },
        {
          "type": "string",
          "const": "inherit"
        }
      ]
    },
    "AuthBasic": {
      "type": "object",
      "description": "Basic authentication",
      "properties": {
        "type": {
          "type": "string",
          "const": "basic"
        },
        "username": {
          "type": "string",
          "description": "Username for basic auth"
        },
        "password": {
          "type": "string",
          "description": "Password for basic auth"
        }
      },
      "required": [
        "type"
      ],
      "additionalProperties": false
    },
    "AuthApiKey": {
      "type": "object",
      "description": "API Key authentication",
      "properties": {
        "type": {
          "type": "string",
          "const": "apikey"
        },
        "key": {
          "type": "string",
          "description": "API key name"
        },
        "value": {
          "type": "string",
          "description": "API key value"
        },
        "placement": {
          "type": "string",
          "enum": [
            "header",
            "query"
          ],
          "description": "Where to place the API key"
        }
      },
      "required": [
        "type"
      ],
      "additionalProperties": false
    },
    "AuthBearer": {
      "type": "object",
      "description": "Bearer token authentication",
      "properties": {
        "type": {
          "type": "string",
          "const": "bearer"
        },
        "token": {
          "type": "string",
          "description": "Bearer token"
        }
      },
      "required": [
        "type"
      ],
      "additionalProperties": false
    },
    "AuthDigest": {
      "type": "object",
      "description": "Digest authentication",
      "properties": {
        "type": {
          "type": "string",
          "const": "digest"
        },
        "username": {
          "type": "string",
          "description": "Username for digest auth"
        },
        "password": {
          "type": "string",
          "description": "Password for digest auth"
        }
      },
      "required": [
        "type"
      ],
      "additionalProperties": false
    }
  }
}
