---
naftiko: "0.4"
info:
  label: "CIR Time Export"
  description: "Extracts CIR-eligible time tracking data from Notion for a given date range, with breakdown by person, project, and activity. Designed for automated CIR (Crédit d'Impôt Recherche) reporting."
  tags:
    - cir
    - time-tracking
    - notion
    - reporting
  created: "2026-02-19"
  modified: "2026-02-19"
  stakeholders:
    - role: "owner"
      fullName: "Thomas Eskenazi"
      email: "thomaseskenazi@naftiko.io"

capability:
  exposes:
    - type: "api"
      address: "localhost"
      port: 8090
      namespace: "cir"
      resources:
        - path: "/time-report"
          name: "time-report"
          label: "CIR Time Report"
          description: "API endpoint for retrieving CIR-eligible time tracking data with breakdown by person, project, and activity."
          inputParameters:
            - name: "start_date"
              description: "Start date for the time report (inclusive), in YYYY-MM-DD format"
              in: "query"
              type: "string"
              pattern: "^\\d{4}-\\d{2}-\\d{2}$"
            - name: "end_date"
              description: "End date for the time report (inclusive), in YYYY-MM-DD format"
              in: "query"
              type: "string"
              pattern: "^\\d{4}-\\d{2}-\\d{2}$"
          operations:
            - name: "get-time-report"
              method: "GET"
              label: "Get CIR Time Report"
              outputParameters:
                - name: "entries"
                  type: "array"
                  items:
                    - name: "date"
                      type: "string"
                    - name: "project_morning"
                      type: "string"
                    - name: "activity_morning"
                      type: "string"
                    - name: "project_afternoon"
                      type: "string"
                    - name: "activity_afternoon"
                      type: "string"
                    - name: "person"
                      type: "string"
              steps:
                - type: "call"
                  name: "fetch-projects"
                  call: "notion.query-projects"
                - type: "call"
                  name: "fetch-entries"
                  call: "notion.query-entries"
                  with:
                    start_date: "$this.cir.start_date"
                    end_date: "$this.cir.end_date"
                - type: "lookup"
                  name: "morning-project"
                  index: "fetch-projects"
                  match: "ids"
                  lookupValue: "$.fetch-entries.morning-ids"
                  outputParameters:
                    - "projects"
                    - "activities"
                - type: "lookup"
                  name: "afternoon-project"
                  index: "fetch-projects"
                  match: "ids"
                  lookupValue: "$.fetch-entries.afternoon-ids"
                  outputParameters:
                    - "projects"
                    - "activities"
              mappings:
                - targetName: "date"
                  value: "$.fetch-entries.dates"
                - targetName: "project_morning"
                  value: "$.morning-project.projects"
                - targetName: "activity_morning"
                  value: "$.morning-project.activities"
                - targetName: "project_afternoon"
                  value: "$.afternoon-project.projects"
                - targetName: "activity_afternoon"
                  value: "$.afternoon-project.activities"
                - targetName: "person"
                  value: "$.fetch-entries.persons"

  consumes:
    - type: "http"
      description: "Notion API integration for accessing project and time tracking data relevant to CIR reporting."
      namespace: "notion"
      baseUri: "https://api.notion.com/v1"
      authentication:
        type: "bearer"
        token: "${NOTION_INTEGRATION_TOKEN}"
      inputParameters:
        - name: "Notion-Version"
          in: "header"
          value: "2022-06-28"
        - name: "Content-Type"
          in: "header"
          value: "application/json"
      resources:
        - name: "projects-db"
          label: "Projects Database"
          path: "/databases/${PROJECTS_DATABASE_ID}/query"
          operations:
            - name: "query-projects"
              method: "POST"
              label: "Query CIR-eligible Projects"
              body:
                type: json
                data:
                  filter:
                    property: "CIR Scope"
                    select:
                      equals: "Yes"
              outputParameters:
                - name: "ids"
                  type: "array"
                  value: "$.results[*].id"
                - name: "projects"
                  type: "array"
                  value: "$.results[*].properties.Project.select.name"
                - name: "activities"
                  type: "array"
                  value: "$.results[*].properties.Activity.select.name"

        - name: "time-tracker-db"
          label: "Time Tracker Database"
          path: "/databases/${TIME_TRACKER_DATABASE_ID}/query"
          operations:
            - name: "query-entries"
              method: "POST"
              label: "Query Time Entries for Date Range"
              inputParameters:
                - name: "start_date"
                  in: "body"
                - name: "end_date"
                  in: "body"
              body:
                type: json
                data:
                  filter:
                    and:
                      - property: "Day"
                        date:
                          on_or_after: "{{start_date}}"
                      - property: "Day"
                        date:
                          before: "{{end_date}}"
              outputParameters:
                - name: "dates"
                  type: "array"
                  value: "$.results[*].properties.Day.date.start"
                - name: "persons"
                  type: "array"
                  value: "$.results[*].properties.Person.people[0].id"
                - name: "morning-ids"
                  type: "array"
                  value: "$.results[*].properties.Morning.relation[0].id"
                - name: "afternoon-ids"
                  type: "array"
                  value: "$.results[*].properties.Afternoon.relation[0].id"
