{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://naftiko.io/schemas/v0.2/capability.json",
  "title": "Naftiko Capability Specification",
  "description": "This Schema should be used to describe and validate Naftiko Capabilities",
  "type": "object",
  "properties": {
    "naftiko": {
      "type": "string",
      "description": "Version of the Naftiko schema",
      "const": "0.2"
    },
    "info": {
      "$ref": "#/$defs/Info"
    },
    "capability": {
      "$ref": "#/$defs/Capability"
    }
  },
  "required": [
    "naftiko",
    "info",
    "capability"
  ],
  "additionalProperties": false,
  "$defs": {
    "Address": {
      "type": "string",
      "description": "hostname or IP for the exposition",
      "anyOf": [
        {
          "format": "hostname"
        },
        {
          "format": "ipv4"
        },
        {
          "format": "ipv6"
        }
      ]
    },
    "Protocol": {
      "type": "string",
      "description": "Protocol/format used",
      "enum": [
        "rest/json",
        "rest/xml",
        "grpc",
        "graphql",
        "soap"
      ],
      "default": "rest/json"
    },
    "Info": {
      "type": "object",
      "description": "Information about the capability",
      "properties": {
        "name": {
          "type": "string",
          "description": "The name of the capability"
        },
        "description": {
          "type": "string",
          "description": "A description of the capability (the more meaningful, the easier for agents discovery)"
        }
      },
      "required": [
        "name",
        "description"
      ],
      "additionalProperties": false
    },
    "Capability": {
      "type": "object",
      "description": "Capability technical configuration",
      "properties": {
        "exposes": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/Exposes"
          },
          "minItems": 1
        },
        "consumes": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/Consumes"
          },
          "minItems": 1,
          "if": {
            "minItems": 2
          },
          "then": {
            "items": {
              "required": [
                "targetUri",
                "expositionSuffix"
              ]
            }
          }
        }
      },
      "required": [
        "exposes",
        "consumes"
      ],
      "additionalProperties": false
    },
    "Exposes": {
      "type": "object",
      "description": "Exposition endpoint configuration",
      "properties": {
        "address": {
          "$ref": "#/$defs/Address"
        },
        "port": {
          "type": "integer",
          "description": "Port number for the Exposition endpoint",
          "minimum": 1,
          "maximum": 65535
        },
        "protocol": {
          "$ref": "#/$defs/Protocol"
        },
        "authentication": {
          "$ref": "#/$defs/Authentication",
          "default": "inherit"
        }
      },
      "required": [
        "port"
      ],
      "additionalProperties": false
    },
    "Consumes": {
      "type": "object",
      "description": "configuration for consuming multiple entries (requires routing suffix)",
      "properties": {
        "expositionSuffix": {
          "type": "string",
          "description": "Path suffix used to route to this consumes at the exposes level",
          "pattern": "^[a-zA-Z0-9_-]+$"
        },
        "targetUri": {
          "type": "string",
          "description": "Target URI for the consumes API (supports {{path}} placeholder)",
          "format": "uri-template",
          "pattern": "^.*\\{\\{path\\}\\}.*$"
        },
        "protocol": {
          "$ref": "#/$defs/Protocol"
        },
        "authentication": {
          "$ref": "#/$defs/Authentication",
          "default": "inherit"
        }
      },
      "required": [
        "targetUri"
      ],
      "additionalProperties": false
    },
    "Authentication": {
      "description": "Authentication",
      "oneOf": [
        {
          "$ref": "#/$defs/AuthBasic"
        },
        {
          "$ref": "#/$defs/AuthApiKey"
        },
        {
          "$ref": "#/$defs/AuthBearer"
        },
        {
          "$ref": "#/$defs/AuthDigest"
        },
        {
          "type": "string",
          "const": "inherit"
        }
      ]
    },
    "AuthBasic": {
      "type": "object",
      "description": "Basic authentication",
      "properties": {
        "type": {
          "type": "string",
          "const": "basic"
        },
        "username": {
          "type": "string",
          "description": "Username for basic auth"
        },
        "password": {
          "type": "string",
          "description": "Password for basic auth"
        }
      },
      "required": [
        "type"
      ],
      "additionalProperties": false
    },
    "AuthApiKey": {
      "type": "object",
      "description": "API Key authentication",
      "properties": {
        "type": {
          "type": "string",
          "const": "apikey"
        },
        "key": {
          "type": "string",
          "description": "API key name"
        },
        "value": {
          "type": "string",
          "description": "API key value"
        },
        "placement": {
          "type": "string",
          "enum": [
            "header",
            "query"
          ],
          "description": "Where to place the API key"
        }
      },
      "required": [
        "type"
      ],
      "additionalProperties": false
    },
    "AuthBearer": {
      "type": "object",
      "description": "Bearer token authentication",
      "properties": {
        "type": {
          "type": "string",
          "const": "bearer"
        },
        "token": {
          "type": "string",
          "description": "Bearer token"
        }
      },
      "required": [
        "type"
      ],
      "additionalProperties": false
    },
    "AuthDigest": {
      "type": "object",
      "description": "Digest authentication",
      "properties": {
        "type": {
          "type": "string",
          "const": "digest"
        },
        "username": {
          "type": "string",
          "description": "Username for digest auth"
        },
        "password": {
          "type": "string",
          "description": "Password for digest auth"
        }
      },
      "required": [
        "type"
      ],
      "additionalProperties": false
    }
  }
}
